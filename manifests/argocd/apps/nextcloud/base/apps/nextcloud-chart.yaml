apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: nextcloud
  annotations:
    argocd.argoproj.io/sync-wave: "51"
spec:
  destination:
    namespace: nextcloud
    server: https://kubernetes.default.svc
  project: cluster-config
  source:
    repoURL: https://nextcloud.github.io/helm/
    chart: nextcloud
    targetRevision: 3.5.3
    helm:
      values: |-

        nextcloud:
          host: nextcloud.nextcloud.svc.cluster.local
          existingSecret:
            enabled: true
            secretName: nextcloud-credentials
            usernameKey: admin-user
            passwordKey: admin-password
            smtpUsernameKey: smtp-user
            smtpPasswordKey: smtp-password
          containerPort: 80
          mail:
            enabled: true
            fromAddress: home
            domain: famjanz.de
            smtp:
              host: smtp.strato.de
              port: 465
          extraEnv:
            - name: NEXTCLOUD_HOSTNAME
              value: nextcloud.nextcloud.svc.cluster.local
          configs:
            proxy.config.php: |-
              <?php
              $CONFIG = array (
                'trusted_proxies' => array(
                  0 => '127.0.0.1',
                  1 => '10.0.0.0/8',
                ),
                'trusted_domains' =>
                  array (
                  0 => 'localhost',
                  1 => 'cloud.apps.sakaarr.janz.digital',
                  2 => 'cloud.janz.digital',
                  3 => 'nextcloud.nextcloud.svc.cluster.local'
                ),
                'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
              );

        internalDatabase:
          enabled: false

        externalDatabase:
          enabled: true
          type: postgresql
          host: nextcloud-db-postgresql
          database: nextcloud
          existingSecret:
            enabled: true
            secretName: nextcloud-db-postgresql
            usernameKey: username
            passwordKey: password
        redis:
          enabled: true

        persistence:
          enabled: true
          storageClass: odf-lvm-vg1
          nextcloudData:
            enabled: true
            storageClass: odf-lvm-vg1

        metrics:
          enabled: true
          serviceMonitor:
            enabled: true

  syncPolicy:
    syncOptions:
      - CreateNamespace=true
