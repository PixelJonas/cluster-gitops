apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: owncloud
  namespace: argocd-operator-system
  annotations:
    argocd.argoproj.io/sync-wave: "111"
spec:
  destination:
    namespace: owncloud
    server: "https://kubernetes.default.svc"
  source:
    repoURL: "https://github.com/owncloud/ocis-charts.git"
    path: charts/ocis
    targetRevision: external-user-management
    helm:
      values: |-

        externalDomain: cloud.apps.titan.janz.digital
        autoscaling:
          enabled: false

        extraLabels:
          kanister.kasten.io/inject-sidecar: "true"
          k10.kasten.io/forcegenericbackup: "true"

        features:
          emailNotifications: true
          demoUsers: false
          externalUserManagement:
            enabled: true
            oidc:
              issuerURI: https://sso.janz.digital/auth/realms/janz

        ingress:
          enabled: true
          ingressClassName: nginx
          annotations:
            nginx.ingress.kubernetes.io/proxy-body-size: 50m
          tls:
            - hosts:
              - cloud.apps.titan.janz.digital
              secretName: ocis-tls-certificate

        insecure:
          oidcIdpInsecure: true
          ocisHttpApiInsecure: fals

        logging:
          level: debug

        # References to secrets.
        # The secrets need to be manually created.
        # See https://github.com/owncloud/ocis-charts/blob/master/charts/ocis/README.md#secrets for how to generate them.
        secretRefs:
          adminUserSecretRef: "sealed-admin-user"
          idpSecretRef: "sealed-idp-secrets"
          jwtSecretRef: "sealed-jwt-secret"
          ldapCaRef: "sealed-ldap-ca"
          ldapCertRef: "sealed-ldap-cert"
          ldapSecretRef: "sealed-ldap-bind-secrets"
          machineAuthApiKeySecretRef: "sealed-machine-auth-api-key"
          notificationsSmtpSecretRef: "sealed-notifications-smtp-secret"
          storageSystemJwtSecretRef: "sealed-storage-system-jwt-secret"
          storageSystemSecretRef: "sealed-storage-system"
          thumbnailsSecretRef: "sealed-thumbnails-transfer-secret"
          transferSecretSecretRef: "sealed-transfer-secret"

  project: cluster-apps
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true
