apiVersion: batch/v1
kind: CronJob
metadata:
  name: immich-backup
  namespace: immich
  annotations:
    argocd.argoproj.io/sync-wave: "200"
spec:
  schedule: "0 3 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: pipeline
          volumes:
            - name: backup
              persistentVolumeClaim:
                claimName: data-immich-db-backup
          containers:
            - name: pg-dump-via-kubectl
              env:
                - name: POSTGRESQL_VOLUME_DIR
                  value: /bitnami/postgresql
                - name: POSTGRES_USER
                  value: immich
                - name: POSTGRES_POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: immich-db-postgresql
                      key: postgres-password
                - name: POSTGRES_DB
                  value: immich
              volumeMounts:
                - name: backup
                  mountPath: /backup
              image: quay.io/openshift/origin-cli:4.14
              command: ["/bin/bash", "-c"]
              args:
                - |-
                  set -e

                  echo -----------------------------------
                  echo "Backing up $POSTGRES_USER database"
                    kubectl exec "$POSTGRES_USER"-db-postgresql-0 --container postgresql -- /bin/bash -c 'PGPASSWORD=$POSTGRES_POSTGRES_PASSWORD pg_dump -U postgres -d $POSTGRES_DB' > /backup/backup.sql
                  echo -----------------------------------
                    ls -lah /backup
                  echo -----------------------------------
          restartPolicy: OnFailure
