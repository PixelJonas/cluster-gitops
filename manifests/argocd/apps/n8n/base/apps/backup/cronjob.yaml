apiVersion: batch/v1
kind: CronJob
metadata:
  name: n8n-backup
  namespace: n8n
  annotations:
    argocd.argoproj.io/sync-wave: "200"
spec:
  schedule: "0 3 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: pipeline
          volumes:
            - name: backup
              persistentVolumeClaim:
                claimName: syno-n8n-db-backup
          containers:
            - name: pg-dump-via-kubectl
              env:
                - name: POSTGRESQL_VOLUME_DIR
                  value: /bitnami/postgresql
                - name: POSTGRES_USER
                  value: n8n
                - name: POSTGRES_POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: n8n-db-postgresql
                      key: postgres-password
              volumeMounts:
                - name: backup
                  mountPath: /backup
              image: quay.io/openshift/origin-cli:4.21
              command: ["/bin/bash", "-c"]
              args:
                - |-
                  set -e

                  echo -----------------------------------
                  echo "Backing up $POSTGRES_USER database"
                  kubectl exec "$POSTGRES_USER"-db-postgresql-0 --container postgresql -- /bin/bash -c "PGPASSWORD=$POSTGRES_POSTGRES_PASSWORD pg_dumpall -U postgres" > /backup/backup.sql
                  echo -----------------------------------
                    ls -lah /backup
                  echo -----------------------------------
          restartPolicy: OnFailure
