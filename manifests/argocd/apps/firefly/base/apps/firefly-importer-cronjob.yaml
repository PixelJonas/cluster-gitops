apiVersion: batch/v1
kind: CronJob
metadata:
  name: firefly-importer-cron
  namespace: firefly
  annotations:
    argocd.argoproj.io/sync-wave: "200"
spec:
  schedule: "0 7 */7 * *"
  jobTemplate:
    spec:
      podFailurePolicy:
        rules:
          - action: Ignore
            onExitCodes:
              containerName: firefly-import-cron
              operator: NotIn
              values: [0]
      template:
        spec:
          serviceAccountName: pipeline
          volumes:
            - name: import
              persistentVolumeClaim:
                claimName: firefly-importer-pvc
          containers:
            - name: firefly-import-cron
              image: docker.io/fireflyiii/data-importer:latest-cli
              volumeMounts:
              - name: import
                mountPath: /import
              env:
                - name: TZ
                  value: Europe/Berlin
                - name: APP_DEBUG
                  value: "true"
                - name: IGNORE_DUPLICATE_ERRORS
                  value: "true"
                - name: IGNORE_NOT_FOUND_TRANSACTIONS
                  value: "true"
                - name: LOG_LEVEL
                  value: debug
                - name: LOG_CHANNEL
                  value: stack
                - name: MAIL_DESTINATION
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: maildestination
                - name: MAIL_MAILER
                  value: smtp
                - name: MAIL_ENCRYPTION
                  value: ssl
                - name: MAIL_PORT
                  value: "465"
                - name: ENABLE_MAIL_REPORT
                  value: "true"
                - name: MAIL_HOST
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: mailhost
                - name: MAIL_FROM_ADDRESS
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: mailfrom
                - name: MAIL_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: mailusername
                - name: MAIL_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: mailpassword
                - name: TRUSTED_PROXIES 
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: trustedproxies
                - name: FIREFLY_III_URL
                  value: http://firefly.firefly.svc.cluster.local:8080
                - name: VANITY_URL
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: appurl
                - name: NORDIGEN_ID
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: fireflynordigenid
                - name: NORDIGEN_KEY
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: fireflynordigenkey
                - name: AUTO_IMPORT_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: autoimportsecret
                - name: FIREFLY_III_ACCESS_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: firefly-credentials
                      key: fireflyaccesstoken
                - name: CAN_POST_AUTOIMPORT
                  value: "true"
                - name: IMPORT_DIR_ALLOWLIST
                  value: /import
                - name: CAN_POST_FILES
                  value: "true"
                - name: EXPECT_SECURE_URL
                  value: "true"
          restartPolicy: Never
