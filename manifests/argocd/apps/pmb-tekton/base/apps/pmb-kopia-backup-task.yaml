apiVersion: tekton.dev/v1beta1
kind: ClusterTask
metadata:
  name: pmb-kopia-backup
spec:
  params:
    - name: KOPIA_PASSWORD
      type: string
      description: name of the secret with key "kopia_password" containing the kopia repo password (default kopia)
      default: kopia
  workspaces:
    - name: source-dir
    - name: kopia-repo-dir
  steps:
    - name: kopia-backup
      image: ghcr.io/onedr0p/kopia:0.12.1
      env:
        - name: KOPIA_PASSWORD
          value: $(params.KOPIA_PASSWORD)
        - name: PMB__SRC_DIR
          value: $(workspaces.source-dir.path)
        - name: PMB__DEST_DIR
          value: $(workspaces.kopia-repo-dir.path)
      command: ["/bin/bash", "-c"]
      args:
        - |-
            printf "\e[1;32m%-6s\e[m\n" "[01/08] Create repo ..."              && [[ ! -f "${PMB__DEST_DIR}"/repo/kopia.repository.f ]] && kopia repository create filesystem --path="${PMB__DEST_DIR}"/repo
            printf "\e[1;32m%-6s\e[m\n" "[02/08] Connect to repo ..."          && kopia repo connect filesystem --path="${PMB__DEST_DIR}"/repo --override-hostname=cluster --override-username=root
            printf "\e[1;32m%-6s\e[m\n" "[03/08] Set policies ..."             && kopia policy set "${PMB__DEST_DIR}"/repo --compression=zstd --keep-latest 14 --keep-hourly 0 --keep-daily 7 --keep-weekly 2 --keep-monthly 0 --keep-annual 0
            printf "\e[1;32m%-6s\e[m\n" "[04/08] Snapshot {{ claimName }} ..." && kopia snap create "${PMB__SRC_DIR}"
            printf "\e[1;32m%-6s\e[m\n" "[05/08] List snapshots ..."           && kopia snap list "${PMB__SRC_DIR}"
            printf "\e[1;32m%-6s\e[m\n" "[06/08] Show stats ..."               && kopia content stats
            printf "\e[1;32m%-6s\e[m\n" "[07/08] Show maintenance info ..."    && kopia maintenance info
            printf "\e[1;32m%-6s\e[m\n" "[08/08] Disconnect from repo ..."     && kopia repo disconnect